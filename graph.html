<html>
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="graph_data.json" charset="UTF-8"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<canvas id="myCanvas" width="1800" height="900" style="border:1px solid #d3d3d3">

<script>
var dragObj;
var elem_id_to_members = {}
var c = document.getElementById("myCanvas");
W = c.scrollWidth;
H = c.scrollHeight;

function get_card_name(member) {
    return('card ' + member['name']);
}
function get_card_rect(member_id){
    return(graph_data["members"][member_id]['card'].getBoundingClientRect());
}
function connect_cards(ctx, rect1, rect2) {
    ctx.moveTo((rect1.left + rect1.right) / 2 , (rect1.top + rect1.bottom) / 2);
    ctx.lineTo((rect2.left + rect2.right) / 2 , (rect2.top + rect2.bottom) / 2);
}

function get_dist(rect1, rect2) {
    
}

function draw_lines() {
    var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");
    ctx.clearRect(0,0,W,H);
    ctx.beginPath();
    ctx.strokeStyle = "#AADDFF";
    for (i=0; i<graph_data["members"].length; i++) {
        var member1 = graph_data["members"][i];
        var rect1 = member1['card'].getBoundingClientRect();
        for (j=0; j<member1['friends'].length; j++) {
            var member2 = elem_id_to_members['card ' + member1['friends'][j]]
            var rect2 = member2['card'].getBoundingClientRect();
            connect_cards(ctx, rect1, rect2);
        }
    }
    ctx.stroke();
}

DECAY = 0.99
APART = 0.03
TOGETHER = 0.000001


function moveit() {
    for (i=0; i<graph_data["members"].length; i++) {
        var member1 = graph_data["members"][i];
        member1['vx'] = member1['vx'] * DECAY;
        member1['vy'] = member1['vy'] * DECAY;
        if (Math.random() < 0.001) {
            member1['vx'] = member1['vx'] + (Math.random() - 0.5) * 3;
            member1['vy'] = member1['vy'] + (Math.random() - 0.5) * 3;
        }
    }
    for (i=0; i<graph_data["members"].length; i++) {
        var member1 = graph_data["members"][i];
        var rect1 = member1['card'].getBoundingClientRect();
        var card1 = member1['card'];
        for (j=i+1; j<graph_data["members"].length; j++) {
            var member2 = graph_data["members"][j];
            var rect2 = member2['card'].getBoundingClientRect();
            var card2 = member2['card'];
            dist = Math.pow(Math.pow(rect1.top-rect2.top, 2) + Math.pow(rect1.left-rect2.left, 2), 0.5)
            atan = Math.atan2(rect1.left-rect2.left, rect1.top-rect2.top);
            if (dist < 100) {
                member1['vx'] = member1['vx'] + Math.sin(atan) * APART;
                member1['vy'] = member1['vy'] + Math.cos(atan) * APART;
                member2['vx'] = member2['vx'] - Math.sin(atan) * APART;
                member2['vy'] = member2['vy'] - Math.cos(atan) * APART;
            }
            if (dist > 100) {
                if (member1['friends'].includes(member2['name'])) {
                    var mdist = Math.min(dist, 500);
                    member1['vx'] = member1['vx'] - Math.sin(atan) * TOGETHER * mdist;
                    member1['vy'] = member1['vy'] - Math.cos(atan) * TOGETHER * mdist;
                    member2['vx'] = member2['vx'] + Math.sin(atan) * TOGETHER * mdist;
                    member2['vy'] = member2['vy'] + Math.cos(atan) * TOGETHER * mdist;
                }
            }
        }
    }
    
    for (i=0; i<graph_data["members"].length; i++) {
        var member1 = graph_data["members"][i];
        var rect1 = member1['card'].getBoundingClientRect();
        var card1 = member1['card'];
        if (card1 !== dragObj) {
            card1.style.left = parseFloat(card1.style.left.slice(0, -2)) + member1['vx'] + 'px';
            card1.style.top  = parseFloat(card1.style.top.slice(0, -2))  + member1['vy'] + 'px';
        }
    }
    draw_lines();
}


function set_drag_drop(obj) {
	obj.adx = 0;
	obj.ady = 0;
	
	obj.onmousedown = function(e)
	{
		var rect = obj.getBoundingClientRect();
		obj.dx = rect.left - e.clientX;
		obj.dy = rect.top - e.clientY;
		obj.isDown = true;
		dragObj = this;
	}

	obj.onmouseup = function(e)
	{
		obj.isDown = false;
	}

	document.onmousemove = function(e)
	{
		if(dragObj && dragObj.isDown)
		{
			dragObj.style.left = e.pageX -dragObj.adx+ dragObj.dx +"px";
			dragObj.style.top = e.pageY -dragObj.ady+ dragObj.dy + "px";
            draw_lines();
		}
	}
}


for (i=0; i<graph_data["members"].length; i++) {
    member = graph_data["members"][i]
    var elem = document.createElement('div');
    member['card'] = elem;
    elem.className = "card-back";
    elem.id = get_card_name(member);
    elem_id_to_members[elem.id] = member;
    elem.innerHTML = '<div><a href="' + member['url'] + '">' + member['name'] + '</a></div><img src="' + member['img'] + '" class="avatar">'
    document.body.appendChild(elem);
    set_drag_drop(elem);
    elem.style.left = member['x'] * W
    elem.style.top = member['y'] * H
    member['vx'] = 0;
    member['vy'] = 0;
}

draw_lines();

setInterval(moveit, 10);

</script>
</html>